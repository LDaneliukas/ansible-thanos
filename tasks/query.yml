---
# Configure the query backend, systemd files, etc
- name: validate that required variables are set
  assert:
    that:
      - '{{ item }} != ""'
    msg: "{{ item }} must be set"
  with_items:
    - thanos_query_s3_bucket_name
    - thanos_query_s3_endpoint
    - thanos_query_prometheus_url
    - thanos_query_prometheus_data_dir

- name: Install thanos query systemd file
  template:
    src: thanos-sidecar.j2
    dest: /etc/systemd/system/thanos-query.service
  register: query_systemd
  notify: restart thanos-query

- name: Reload systemd if thanos query changed
  systemd:
    daemon_reload: yes

- name: Add defaults file
  template:
    src: thanos-query-defaults.j2
    dest: /etc/default/thanos-query
  notify: restart thanos-sidecar

- name: Ensure thanos-query is started
  service:
    name: thanos-query
    enabled: yes
    state: started
